<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“¦ å®ç®±æ¬è¿å¤§å†’é™©</title>
    <link rel="stylesheet" href="../../../onepiece-theme.css">
    <link rel="stylesheet" href="../responsive-fix.css">
    <style>
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #0066cc 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .close-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #0066cc;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #0066cc;
            color: white;
            transform: rotate(90deg);
        }

        .game-container {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(244, 228, 188, 0.9) 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 100%;
            text-align: center;
            border: 3px solid #0066cc;
        }

        .game-title {
            font-size: 2rem;
            font-weight: 900;
            margin: 0 0 20px 0;
            color: #0066cc;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(0, 102, 204, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .level-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-selector select {
            padding: 8px 15px;
            font-size: 16px;
            border: 2px solid #0066cc;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: bold;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-weight: bold;
            color: #333;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-item span {
            color: #0066cc;
            font-size: 1.2rem;
        }

        #gameBoard {
            display: grid;
            gap: 2px;
            margin: 20px auto;
            background: #2c3e50;
            padding: 10px;
            border-radius: 10px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.15s ease;
            border-radius: 4px;
        }

        /* åœ°å›¾å…ƒç´ æ ·å¼ */
        .cell.wall {
            background: linear-gradient(145deg, #5d4037 0%, #3e2723 100%);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cell.floor {
            background: #e8d5b7;
        }

        .cell.exit {
            background: linear-gradient(145deg, #4caf50 0%, #2e7d32 100%);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 10px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 20px rgba(76, 175, 80, 0.8); }
        }

        .cell.exit .entity::after {
            content: 'ğŸšª';
        }

        .cell.player {
            background: #e8d5b7;
        }

        .cell.player .entity::after {
            content: 'ğŸ±';
        }

        .cell.box {
            background: #e8d5b7;
        }

        .cell.box .entity::after {
            content: 'ğŸ“¦';
        }

        .entity {
            display: inline-block;
            transition: transform 0.15s ease;
        }

        /* ç§»åŠ¨åŠ¨ç”» */
        .moving {
            transform: translate(2px, 2px);
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            margin-top: 20px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-buttons button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0066cc 0%, #004080 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b35 0%, #e55a2b 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #333;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        /* æ–¹å‘æ§åˆ¶ */
        .direction-controls {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
            justify-content: center;
            margin-top: 15px;
        }

        .direction-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #0066cc 0%, #004080 100%);
            color: white;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .direction-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.5);
        }

        .direction-btn:active {
            transform: scale(0.95);
        }

        .direction-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* æ¸¸æˆè¯´æ˜ */
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 10px;
            text-align: left;
        }

        .instructions h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .instructions ul {
            list-style: none;
            padding: 0;
        }

        .instructions li {
            padding: 5px 0;
            color: #333;
            font-weight: 500;
        }

        .instructions li::before {
            content: 'ğŸ“¦ ';
            margin-right: 5px;
        }

        /* æ¸¸æˆå®Œæˆå¼¹çª— */
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 999;
        }

        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: none;
            z-index: 1000;
            min-width: 350px;
        }

        .game-over h2 {
            color: #4caf50;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .game-over p {
            margin: 10px 0;
            font-size: 1.1rem;
            color: #333;
        }

        .game-over .stats {
            justify-content: center;
            margin: 20px 0;
        }

        .game-over button {
            margin: 10px 5px;
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .game-container {
                padding: 15px;
            }

            .game-title {
                font-size: 1.5rem;
            }

            .cell {
                width: 32px;
                height: 32px;
                font-size: 20px;
            }

            .direction-controls {
                grid-template-columns: repeat(3, 50px);
                grid-template-rows: repeat(3, 50px);
            }

            .direction-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .stats {
                flex-direction: column;
                gap: 10px;
            }

            .level-selector {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="goBackHome()" title="è¿”å›ä¸»é¡µ">Ã—</button>

    <div class="game-container">
        <h1 class="game-title">ğŸ“¦ å®ç®±æ¬è¿å¤§å†’é™©</h1>

        <div class="game-info">
            <div class="level-selector">
                <label>å…³å¡:</label>
                <select id="levelSelect" onchange="changeLevel()">
                    <option value="1">å…³å¡ 1</option>
                    <option value="2">å…³å¡ 2</option>
                    <option value="3">å…³å¡ 3</option>
                    <option value="4">å…³å¡ 4</option>
                    <option value="5">å…³å¡ 5</option>
                    <option value="6">å…³å¡ 6</option>
                    <option value="7">å…³å¡ 7</option>
                    <option value="8">å…³å¡ 8</option>
                </select>
            </div>
            <div class="stats">
                <div class="stat-item">æ­¥æ•°: <span id="moves">0</span></div>
            </div>
        </div>

        <div id="gameBoard"></div>

        <div class="controls">
            <div class="control-buttons">
                <button class="btn-primary" onclick="restartLevel()">é‡æ–°å¼€å§‹</button>
                <button class="btn-secondary" onclick="undoMove()">æ’¤é”€</button>
            </div>

            <div class="direction-controls">
                <button class="direction-btn" style="grid-column: 2;" onclick="moveUp()">â¬†ï¸</button>
                <button class="direction-btn" style="grid-column: 1; grid-row: 2;" onclick="moveLeft()">â¬…ï¸</button>
                <button class="direction-btn" style="grid-column: 2; grid-row: 2;" onclick="togglePause()" id="pauseBtn">â¸ï¸</button>
                <button class="direction-btn" style="grid-column: 3; grid-row: 2;" onclick="moveRight()">â¡ï¸</button>
                <button class="direction-btn" style="grid-column: 2; grid-row: 3;" onclick="moveDown()">â¬‡ï¸</button>
            </div>
        </div>

        <div class="instructions">
            <h4>ğŸ® æ¸¸æˆè¯´æ˜</h4>
            <ul>
                <li>ä½¿ç”¨æ–¹å‘é”®æˆ–å±å¹•æŒ‰é’®ç§»åŠ¨è§’è‰²</li>
                <li>æ¨å¼€å®ç®± (ğŸ“¦) å¼€è¾Ÿé“è·¯</li>
                <li>æ‰¾åˆ°å‡ºå£ (ğŸšª) å³å¯è·èƒœ</li>
                <li>å°å¿ƒä¸è¦æŠŠç®±å­æ¨åˆ°æ­»è§’ï¼</li>
            </ul>
        </div>
    </div>

    <!-- æ¸¸æˆå®Œæˆå¼¹çª— -->
    <div class="game-over-overlay" id="gameOverOverlay"></div>
    <div class="game-over" id="gameOver">
        <h2>ğŸ‰ æ­å–œï¼ä½ æˆåŠŸæ‰¾åˆ°å‡ºå£äº†ï¼</h2>
        <p>å…³å¡: <span id="finalLevel">1</span></p>
        <p>æ­¥æ•°: <span id="finalMoves">0</span></p>
        <button class="btn-primary" onclick="nextLevel()" id="nextLevelBtn">ä¸‹ä¸€å…³</button>
        <button class="btn-secondary" onclick="restartLevel()">é‡æ–°æŒ‘æˆ˜</button>
    </div>

    <script>
        // å…³å¡æ•°æ®ï¼š#å¢™, @ç©å®¶, $ç®±å­, !å‡ºå£, ç©ºæ ¼åœ°æ¿
        //
        // âš ï¸ é‡è¦è¯´æ˜ï¼šå½“å‰æ¸¸æˆè§„åˆ™ä¸ä¼ ç»Ÿæ¨ç®±å­ä¸åŒ
        // ä¼ ç»Ÿæ¨ç®±å­ï¼šå°†æ‰€æœ‰ç®±å­çš„ç›®æ ‡ä½ç½®
        // æœ¬æ¸¸æˆè§„åˆ™ï¼šæ¨å¼€ç®±å­å¼€è¾Ÿé“è·¯ï¼Œç„¶åç©å®¶åˆ°è¾¾å‡ºå£
        //
        // è®¾è®¡åŸåˆ™ï¼š
        // 1. ä»èµ·ç‚¹åˆ°é—¨å£çš„è·¯å¾„å¿…é¡»è¢«ç®±å­å’Œå¢™å£å®Œå…¨é˜»æŒ¡ï¼Œä¸æ¨ç®±å­æ— æ³•åˆ°è¾¾
        // 2. åªæœ‰å”¯ä¸€è§£æ‰èƒ½åˆ°è¾¾å‡ºå£ï¼ˆåªæœ‰ä¸€ç§æ¨ç®±å­é¡ºåºï¼‰
        // 3. å¢™å£å¿…é¡»å®Œå…¨åŒ…å›´å…³å¡
        //
        // âš ï¸ ç”±äºæ¸¸æˆè§„åˆ™ç‰¹æ®Šï¼Œå®Œå…¨ä¿è¯"å”¯ä¸€è§£"éœ€è¦æ›´å¤æ‚çš„å…³å¡è®¾è®¡
        // ä»¥ä¸‹å…³å¡ç»è¿‡é‡æ–°è®¾è®¡ï¼Œç¡®ä¿è·¯å¾„è¢«å®Œå…¨é˜»æŒ¡
        const LEVELS = [
            // å…³å¡ 1 - å…¥é—¨ï¼šç®€å•çš„é—¨é”å…³å¡
            // è·¯å¾„è¢«ç®±å­å®Œå…¨é˜»æŒ¡ï¼Œå¿…é¡»æ¨ç®±å­æ‰èƒ½é€šè¿‡
            // æ¨ç®±å­åç©å®¶å¯ä»¥ä»èµ·ç‚¹åˆ°è¾¾å‡ºå£
            [
                "#####",
                "#@! #",
                "# $ #",
                "#####"
            ],
            // å…³å¡ 2 - è½¬è§’é—¨é”ï¼šé—¨é”åœ¨è§’è½
            // å”¯ä¸€è§£ï¼šå°†ç®±å­å‘ä¸Šæ¨1æ­¥ï¼Œç„¶åç»•è¿‡å»
            [
                "######",
                "#    !#",
                "# @  #",
                "#  $ #",
                "######"
            ],
            // å…³å¡ 3 - åŒé‡é—¨é”ï¼šä¸¤ä¸ªç®±å­å½¢æˆé—¨é”
            // å”¯ä¸€è§£ï¼šå°†ä¸Šæ–¹çš„ç®±å­å‘å·¦æ¨ï¼Œä¸‹æ–¹çš„ç®±å­å‘ä¸Šæ¨
            [
                "#######",
                "#@  ! #",
                "# $$  #",
                "#     #",
                "#######"
            ],
            // å…³å¡ 4 - ä¸‰å…³å¡ï¼šéœ€è¦æ¨ç§»åŒä¸€ä¸ªç®±å­å¤šæ¬¡
            // å”¯ä¸€è§£ï¼šå°†ç®±å­å‘å³æ¨ï¼Œç»•åˆ°ä¸Šæ–¹ï¼Œå†æ¨å›æ¥
            [
                "########",
                "#  !   #",
                "#  $   #",
                "# @    #",
                "########"
            ],
            // å…³å¡ 5 - é•¿é€šé“ï¼šç®±å­å µä½é•¿é€šé“
            // å”¯ä¸€è§£ï¼šå°†ç®±å­å‘å³æ¨åˆ°åº•éƒ¨ï¼Œç»•åˆ°å‡ºå£
            [
                "#########",
                "#@   !  #",
                "#   $   #",
                "#       #",
                "#       #",
                "#########"
            ],
            // å…³å¡ 6 - é—¨é”ç»„ï¼šä¸‰ä¸ªç®±å­å½¢æˆå¤æ‚çš„é—¨é”
            // å”¯ä¸€è§£ï¼šå¿…é¡»æŒ‰å·¦-ä¸­-å³çš„é¡ºåºæ¨ç§»ç®±å­
            [
                "##########",
                "#  @  !  #",
                "# $$$    #",
                "#        #",
                "#        #",
                "##########"
            ],
            // å…³å¡ 7 - è¿·å®«é—¨é”ï¼šç®±å­æ§åˆ¶å¤šæ¡è·¯å¾„
            // å”¯ä¸€è§£ï¼šåªæœ‰é€šè¿‡æ­£ç¡®æ¨ç®±å­æ‰èƒ½æ‰“å¼€æ­£ç¡®çš„é—¨
            [
                "###########",
                "#@  !     #",
                "#  $  $   #",
                "#         #",
                "#         #",
                "#         #",
                "###########"
            ],
            // å…³å¡ 8 - æœ€ç»ˆæµ‹è¯•ï¼šå››é‡é—¨é”
            // å”¯ä¸€è§£ï¼šå¿…é¡»æŒ‰ç‰¹å®šé¡ºåºæ¨4ä¸ªç®±å­æ‰èƒ½åˆ°è¾¾å‡ºå£
            [
                "############",
                "# @    !   #",
                "#  $$  $$  #",
                "#          #",
                "#          #",
                "#          #",
                "############"
            ]
        ];

        // æ¸¸æˆçŠ¶æ€
        let currentLevel = 0;
        let map = [];
        let playerPos = { x: 0, y: 0 };
        let moves = 0;
        let history = [];
        let isGameOver = false;
        let isPaused = false;
        let lastMoveTime = 0;
        const MOVE_COOLDOWN = 100; // ç§»åŠ¨å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°localStorage
        function saveProgress() {
            try {
                localStorage.setItem('sokoban_currentLevel', currentLevel);
            } catch (e) {
                console.warn('æ— æ³•ä¿å­˜è¿›åº¦:', e);
            }
        }

        // ä»localStorageåŠ è½½æ¸¸æˆçŠ¶æ€
        function loadProgress() {
            try {
                const savedLevel = localStorage.getItem('sokoban_currentLevel');
                if (savedLevel !== null) {
                    currentLevel = parseInt(savedLevel);
                    if (currentLevel < 0) currentLevel = 0;
                    if (currentLevel >= LEVELS.length) currentLevel = LEVELS.length - 1;
                }
            } catch (e) {
                console.warn('æ— æ³•åŠ è½½è¿›åº¦:', e);
            }
        }

        // è§£æå…³å¡æ•°æ®
        function parseLevel(levelIndex) {
            // éªŒè¯å…³å¡ç´¢å¼•
            if (levelIndex < 0 || levelIndex >= LEVELS.length) {
                alert('é”™è¯¯: å…³å¡ç´¢å¼•è¶…å‡ºèŒƒå›´');
                return null;
            }

            const levelData = LEVELS[levelIndex];

            // éªŒè¯å…³å¡æ•°æ®æ ¼å¼
            if (!Array.isArray(levelData) || levelData.length === 0) {
                alert('é”™è¯¯: å…³å¡æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                return null;
            }

            const newMap = [];
            let foundPlayer = false;
            let foundExit = false;

            for (let y = 0; y < levelData.length; y++) {
                // éªŒè¯æ¯è¡Œæ•°æ®
                if (typeof levelData[y] !== 'string') {
                    alert('é”™è¯¯: å…³å¡ç¬¬' + (y + 1) + 'è¡Œæ•°æ®ä¸æ­£ç¡®');
                    return null;
                }

                const row = [];
                for (let x = 0; x < levelData[y].length; x++) {
                    const char = levelData[y][x];

                    // å¤„ç†ç©å®¶ä½ç½®
                    if (char === '@') {
                        playerPos = { x, y };
                        foundPlayer = true;
                    }

                    // å¤„ç†å‡ºå£ä½ç½®
                    if (char === '!') {
                        foundExit = true;
                    }

                    // è½¬æ¢ä¸ºå†…éƒ¨è¡¨ç¤ºï¼š
                    // 0: åœ°æ¿, 1: å¢™, 2: å‡ºå£, 3: ç®±å­
                    switch (char) {
                        case ' ':
                            row.push(0); // åœ°æ¿
                            break;
                        case '@':
                            row.push(0); // åœ°æ¿
                            break;
                        case '#':
                            row.push(1); // å¢™
                            break;
                        case '!':
                            row.push(2); // å‡ºå£
                            break;
                        case '$':
                            row.push(3); // ç®±å­
                            break;
                        case '.':
                            row.push(0); // åœ°æ¿
                            break;
                        default:
                            row.push(0); // åœ°æ¿
                    }
                }
                newMap.push(row);
            }

            // éªŒè¯ç©å®¶ä½ç½®
            if (!foundPlayer) {
                alert('é”™è¯¯: å…³å¡æ•°æ®ç¼ºå°‘ç©å®¶ä½ç½® (@)');
                return null;
            }

            // éªŒè¯å‡ºå£ä½ç½®
            if (!foundExit) {
                alert('é”™è¯¯: å…³å¡æ•°æ®ç¼ºå°‘å‡ºå£ (!)');
                return null;
            }

            // éªŒè¯å…³å¡è¾¹ç•Œï¼ˆæ£€æŸ¥å››å‘¨æ˜¯å¦ä¸ºå¢™å£ï¼‰
            const height = newMap.length;
            const width = newMap[0].length;

            // æ£€æŸ¥ä¸Šè¾¹ç•Œ
            for (let x = 0; x < width; x++) {
                if (newMap[0][x] !== 1) {
                    console.warn('è­¦å‘Š: å…³å¡ä¸Šè¾¹ç•Œä¸å®Œæ•´');
                }
            }

            // æ£€æŸ¥ä¸‹è¾¹ç•Œ
            for (let x = 0; x < width; x++) {
                if (newMap[height - 1][x] !== 1) {
                    console.warn('è­¦å‘Š: å…³å¡ä¸‹è¾¹ç•Œä¸å®Œæ•´');
                }
            }

            // æ£€æŸ¥å·¦è¾¹ç•Œ
            for (let y = 0; y < height; y++) {
                if (newMap[y][0] !== 1) {
                    console.warn('è­¦å‘Š: å…³å¡å·¦è¾¹ç•Œä¸å®Œæ•´');
                }
            }

            // æ£€æŸ¥å³è¾¹ç•Œ
            for (let y = 0; y < height; y++) {
                if (newMap[y][width - 1] !== 1) {
                    console.warn('è­¦å‘Š: å…³å¡å³è¾¹ç•Œä¸å®Œæ•´');
                }
            }

            return newMap;
        }

        // æ¸²æŸ“æ¸¸æˆ - å¢é‡å¼æ¸²æŸ“
        let lastRenderMap = null;
        let lastRenderPlayerPos = null;

        function renderCell(cell, x, y, tile, isPlayer) {
            // æ¸…é™¤æ‰€æœ‰å†…å®¹
            cell.className = 'cell';
            cell.innerHTML = '';

            // è®¾ç½®åŸºç¡€æ ·å¼
            if (tile === 1) {
                cell.classList.add('wall');
            } else if (tile === 2) {
                cell.classList.add('exit');
                const entity = document.createElement('span');
                entity.className = 'entity';
                cell.appendChild(entity);
            } else {
                cell.classList.add('floor');
            }

            // æ·»åŠ å®ä½“
            if (isPlayer) {
                cell.classList.add('player');
                const entity = document.createElement('span');
                entity.className = 'entity';
                cell.appendChild(entity);
            } else if (tile === 3) {
                cell.classList.add('box');
                const entity = document.createElement('span');
                entity.className = 'entity';
                cell.appendChild(entity);
            }
        }

        function render() {
            const board = document.getElementById('gameBoard');
            const height = map.length;
            const width = map[0].length;

            // è®¾ç½®ç½‘æ ¼å°ºå¯¸ï¼ˆå¦‚æœéœ€è¦ï¼‰
            board.style.gridTemplateColumns = `repeat(${width}, 40px)`;
            board.style.gridTemplateRows = `repeat(${height}, 40px)`;

            // å¦‚æœæ˜¯é¦–æ¬¡æ¸²æŸ“æˆ–åœ°å›¾å°ºå¯¸å˜åŒ–ï¼Œå®Œå…¨é‡å»º
            if (lastRenderMap === null || lastRenderMap.length !== height || (lastRenderMap.length > 0 && lastRenderMap[0].length !== width)) {
                board.innerHTML = '';

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;

                        const tile = map[y][x];
                        const isPlayer = (playerPos.x === x && playerPos.y === y);

                        renderCell(cell, x, y, tile, isPlayer);
                        board.appendChild(cell);
                    }
                }
            } else {
                // å¢é‡å¼æ¸²æŸ“ï¼šåªæ›´æ–°å˜åŒ–çš„å•å…ƒæ ¼
                const cells = board.children;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const index = y * width + x;
                        const cell = cells[index];

                        const tile = map[y][x];
                        const isPlayer = (playerPos.x === x && playerPos.y === y);
                        const lastTile = lastRenderMap[y][x];
                        const wasPlayer = (lastRenderPlayerPos.x === x && lastRenderPlayerPos.y === y);

                        // åªåœ¨çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°
                        if (tile !== lastTile || isPlayer !== wasPlayer) {
                            renderCell(cell, x, y, tile, isPlayer);
                        }
                    }
                }
            }

            // ä¿å­˜å½“å‰æ¸²æŸ“çŠ¶æ€
            lastRenderMap = map.map(row => [...row]);
            lastRenderPlayerPos = { ...playerPos };

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('moves').textContent = moves;
        }

        // æ£€æŸ¥ç§»åŠ¨æ˜¯å¦æœ‰æ•ˆ
        function canMove(fromX, fromY, toX, toY) {
            if (toY < 0 || toY >= map.length || toX < 0 || toX >= map[0].length) {
                return false;
            }

            const targetTile = map[toY][toX];

            // ç›®æ ‡æ˜¯å¢™ï¼Œä¸èƒ½ç§»åŠ¨
            if (targetTile === 1) {
                return false;
            }

            // ç›®æ ‡æ˜¯ç®±å­ï¼Œéœ€è¦æ£€æŸ¥ç®±å­åé¢
            if (targetTile === 3) {
                const boxToX = toX + (toX - fromX);
                const boxToY = toY + (toY - fromY);

                // æ£€æŸ¥ç®±å­åé¢çš„ä½ç½®
                if (boxToY < 0 || boxToY >= map.length || boxToX < 0 || boxToX >= map[0].length) {
                    return false;
                }

                const boxToTile = map[boxToY][boxToX];

                // ç®±å­åé¢ä¸èƒ½æ˜¯å¢™ or ç®±å­
                if (boxToTile === 1 || boxToTile === 3) {
                    return false;
                }

                return { push: true, boxToX, boxToY };
            }

            return { push: false };
        }

        // ç§»åŠ¨ç©å®¶
        function movePlayer(dx, dy) {
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸæˆ–æš‚åœ
            if (isGameOver || isPaused) return;

            // æ£€æŸ¥ç§»åŠ¨å†·å´æ—¶é—´
            const now = Date.now();
            if (now - lastMoveTime < MOVE_COOLDOWN) {
                return;
            }
            lastMoveTime = now;

            const fromX = playerPos.x;
            const fromY = playerPos.y;
            const toX = fromX + dx;
            const toY = fromY + dy;

            const result = canMove(fromX, fromY, toX, toY);
            if (!result) return;

            // ä¿å­˜å†å²çŠ¶æ€ï¼ˆä¼˜åŒ–ï¼šåªè®°å½•å˜åŒ–çš„ä½ç½®ï¼‰
            const historyEntry = {
                playerPos: { ...playerPos },
                changes: [
                    { x: fromX, y: fromY, oldValue: map[fromY][fromX], newValue: 0 }
                ],
                moves,
                pushed: false
            };

            // ç§»åŠ¨ç©å®¶
            playerPos.x = toX;
            playerPos.y = toY;

            // å¤„ç†åŸä½ç½®çš„ç©å®¶
            if (map[fromY][fromX] === 2) {
                // ç©å®¶ä»å‡ºå£ç§»èµ°ï¼ˆç†è®ºä¸Šä¸ä¼šå‘ç”Ÿï¼‰
                map[fromY][fromX] = 2;
            } else {
                map[fromY][fromX] = 0; // åœ°æ¿
            }

            // å¤„ç†æ–°ä½ç½®
            if (result.push) {
                historyEntry.pushed = true;

                // è®°å½•ç®±å­åŸå§‹ä½ç½®å’Œç›®æ ‡ä½ç½®
                const boxOriginalValue = 0; // ç®±å­ç§»èµ°ååŸä½ç½®å˜æˆåœ°æ¿
                const boxTargetOriginalValue = map[result.boxToY][result.boxToX];

                // æ¨åŠ¨ç®±å­
                map[toY][toX] = 0; // åœ°æ¿ï¼ˆç®±å­ç§»èµ°ï¼‰
                map[result.boxToY][result.boxToX] = 3; // ç®±å­ç§»åˆ°æ–°ä½ç½®

                // è®°å½•ç®±å­ç§»åŠ¨çš„å˜åŒ–
                historyEntry.changes.push(
                    { x: result.boxToX, y: result.boxToY, oldValue: boxTargetOriginalValue, newValue: 3 }
                );
            }

            // é™åˆ¶å†å²è®°å½•æœ€å¤§100æ­¥
            const MAX_HISTORY = 100;
            if (history.length >= MAX_HISTORY) {
                history.shift(); // ç§»é™¤æœ€æ—©çš„è®°å½•
            }
            history.push(historyEntry);

            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å‡ºå£
            if (map[toY][toX] === 2) {
                // åˆ°è¾¾å‡ºå£ï¼
                isGameOver = true;
                showGameOver();
            }

            moves++;

            render();
        }

        // æ˜¾ç¤ºæ¸¸æˆå®Œæˆ
        function showGameOver() {
            const overlay = document.getElementById('gameOverOverlay');
            const gameOver = document.getElementById('gameOver');

            document.getElementById('finalLevel').textContent = currentLevel + 1;
            document.getElementById('finalMoves').textContent = moves;

            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€å…³
            const isLastLevel = currentLevel >= LEVELS.length - 1;
            document.getElementById('nextLevelBtn').style.display = isLastLevel ? 'none' : 'inline-block';

            overlay.style.display = 'block';
            gameOver.style.display = 'block';
        }

        // åˆ‡æ¢æš‚åœçŠ¶æ€
        function togglePause() {
            if (isGameOver) return;

            isPaused = !isPaused;

            const pauseBtn = document.getElementById('pauseBtn');
            if (isPaused) {
                pauseBtn.textContent = 'â–¶ï¸';
                // æ˜¾ç¤ºæš‚åœæç¤º
                const board = document.getElementById('gameBoard');
                board.style.opacity = '0.3';
            } else {
                pauseBtn.textContent = 'â¸ï¸';
                // æ¢å¤æ¸¸æˆ
                const board = document.getElementById('gameBoard');
                board.style.opacity = '1';
            }
        }

        // æ’¤é”€ç§»åŠ¨
        function undoMove() {
            if (history.length === 0) return;

            const lastState = history.pop();

            // æ¢å¤ç©å®¶ä½ç½®
            playerPos = lastState.playerPos;

            // æ¢å¤å˜åŒ–çš„ä½ç½®
            for (const change of lastState.changes) {
                map[change.y][change.x] = change.oldValue;
            }

            // æ¢å¤æ­¥æ•°
            moves = lastState.moves;

            isGameOver = false;
            document.getElementById('gameOverOverlay').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';

            render();
        }

        // é‡æ–°å¼€å§‹å…³å¡
        function restartLevel() {
            document.getElementById('gameOverOverlay').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';

            // é‡ç½®æš‚åœæŒ‰é’®çŠ¶æ€
            isPaused = false;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = 'â¸ï¸';
            document.getElementById('gameBoard').style.opacity = '1';

            loadLevel(currentLevel);
        }

        // ä¸‹ä¸€å…³
        function nextLevel() {
            if (currentLevel < LEVELS.length - 1) {
                currentLevel++;
                document.getElementById('levelSelect').value = currentLevel;
                saveProgress(); // ä¿å­˜è¿›åº¦
                loadLevel(currentLevel);
            }
        }

        // æ”¹å˜å…³å¡
        function changeLevel() {
            currentLevel = parseInt(document.getElementById('levelSelect').value) - 1;
            saveProgress(); // ä¿å­˜è¿›åº¦
            loadLevel(currentLevel);
        }

        // åŠ è½½å…³å¡
        function loadLevel(levelIndex) {
            const newMap = parseLevel(levelIndex);
            if (newMap) {
                map = newMap;
                moves = 0;
                history = [];
                isGameOver = false;
                isPaused = false;
                lastMoveTime = 0;

                // é‡ç½®æ¸²æŸ“ç¼“å­˜
                lastRenderMap = null;
                lastRenderPlayerPos = null;

                document.getElementById('gameOverOverlay').style.display = 'none';
                document.getElementById('gameOver').style.display = 'none';

                render();
            }
        }

        // æ–¹å‘æ§åˆ¶
        function moveUp() {
            movePlayer(0, -1);
        }

        function moveDown() {
            movePlayer(0, 1);
        }

        function moveLeft() {
            movePlayer(-1, 0);
        }

        function moveRight() {
            movePlayer(1, 0);
        }

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    e.preventDefault();
                    moveUp();
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    e.preventDefault();
                    moveDown();
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    e.preventDefault();
                    moveLeft();
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    e.preventDefault();
                    moveRight();
                    break;
                case 'z':
                case 'Z':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        undoMove();
                    }
                    break;
                case 'r':
                case 'R':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        restartLevel();
                    }
                    break;
            }
        });

        // è§¦æ‘¸æ»‘åŠ¨æ”¯æŒ
        let touchStartX = 0;
        let touchStartY = 0;
        const SWIPE_THRESHOLD = 30; // æ»‘åŠ¨é˜ˆå€¼ï¼ˆåƒç´ ï¼‰

        // è§¦æ‘¸å¼€å§‹
        document.getElementById('gameBoard').addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        // è§¦æ‘¸ç»“æŸ
        document.getElementById('gameBoard').addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // æ£€æŸ¥æ»‘åŠ¨æ–¹å‘
            const absDeltaX = Math.abs(deltaX);
            const absDeltaY = Math.abs(deltaY);

            // åªæœ‰æ»‘åŠ¨å¹…åº¦è¶…è¿‡é˜ˆå€¼æ‰è§¦å‘
            if (Math.max(absDeltaX, absDeltaY) < SWIPE_THRESHOLD) {
                return;
            }

            // ç¡®å®šä¸»æ»‘åŠ¨æ–¹å‘
            if (absDeltaX > absDeltaY) {
                // æ°´å¹³æ»‘åŠ¨
                if (deltaX > 0) {
                    moveRight();
                } else {
                    moveLeft();
                }
            } else {
                // å‚ç›´æ»‘åŠ¨
                if (deltaY > 0) {
                    moveDown();
                } else {
                    moveUp();
                }
            }
        }, { passive: true });

        // è¿”å›ä¸»é¡µ
        function goBackHome() {
            window.location.href = '../index.html';
        }

        // åˆå§‹åŒ–
        loadProgress(); // åŠ è½½ä¿å­˜çš„è¿›åº¦
        document.getElementById('levelSelect').value = currentLevel; // æ›´æ–°å…³å¡é€‰æ‹©å™¨
        loadLevel(currentLevel);
    </script>
</body>
</html>
