<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«é›·æµ·æˆ˜ | One Piece æ¸¸æˆç½‘ç«™</title>
    <link rel="stylesheet" href="../onepiece-theme.css">
    <style>
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .game-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        .info-label {
            font-size: 12px;
            color: #ffd700;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 28px;
            font-weight: bold;
            color: #fff;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .face-btn {
            font-size: 48px;
            cursor: pointer;
            background: none;
            border: none;
            transition: transform 0.2s;
            user-select: none;
        }

        .face-btn:hover {
            transform: scale(1.1);
        }

        .face-btn:active {
            transform: scale(0.95);
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .diff-btn {
            padding: 10px 25px;
            font-size: 16px;
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffd700;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .diff-btn:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
            color: #1a1a2e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .diff-btn.active {
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .game-board {
            display: grid;
            gap: 2px;
            padding: 15px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            margin: 0 auto;
            justify-content: center;
        }

        .game-board-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 100%;
        }

        .cell {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            position: relative;
        }

        /* é•¿æŒ‰è§†è§‰åé¦ˆ */
        .cell.long-pressing {
            transform: scale(0.9);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            z-index: 100;
        }

        /* ç§»åŠ¨ç«¯è§¦æ‘¸åŒºåŸŸæ”¾å¤§ */
        @media (max-width: 600px) {
            .cell::after {
                content: '';
                position: absolute;
                top: -5px;
                left: -5px;
                right: -5px;
                bottom: -5px;
            }
        }

        /* éš¾åº¦ç‰¹å®šæ ·å¼ - è®©é«˜çº§æ¨¡å¼å®Œå…¨æ˜¾ç¤º */
        .game-board.expert .cell {
            width: 28px;
            height: 28px;
            font-size: 14px;
        }

        .game-board.intermediate .cell {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }

        .game-board.beginner .cell {
            width: 35px;
            height: 35px;
            font-size: 18px;
        }

        .cell:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .cell.hidden {
            background: linear-gradient(135deg, #2d4a6f 0%, #1a365d 100%);
            border: 2px solid #4a6fa5;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cell.hidden:hover {
            background: linear-gradient(135deg, #3d5a7f 0%, #2a466d 100%);
        }

        .cell.revealed {
            background: linear-gradient(135deg, #e8f4f8 0%, #d0e8f0 100%);
            border: 1px solid #b0d0e0;
            cursor: default;
        }

        .cell.mine {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: 2px solid #ff0000;
        }

        .cell.flagged {
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
            border: 2px solid #ff9500;
        }

        .cell.exploded {
            background: linear-gradient(135deg, #ff0000 0%, #990000 100%);
            border: 2px solid #ff0000;
            animation: explode 0.3s ease-out;
        }

        @keyframes explode {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .number-1 { color: #0000ff; }
        .number-2 { color: #008000; }
        .number-3 { color: #ff0000; }
        .number-4 { color: #000080; }
        .number-5 { color: #800000; }
        .number-6 { color: #008080; }
        .number-7 { color: #000000; }
        .number-8 { color: #808080; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            max-width: 400px;
            width: 90%;
        }

        .modal h2 {
            color: #ffd700;
            font-size: 36px;
            margin-bottom: 20px;
        }

        .modal p {
            color: #fff;
            font-size: 18px;
            margin: 10px 0;
        }

        .modal-btn {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 18px;
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
            color: #1a1a2e;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .instructions {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .instructions h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .instructions ul {
            color: #fff;
            list-style: none;
            padding: 0;
        }

        .instructions li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .instructions li:before {
            content: "âš“";
            position: absolute;
            left: 0;
            color: #ffd700;
        }

        @media (max-width: 600px) {
            .game-header {
                flex-direction: column;
                gap: 15px;
            }

            .game-info {
                gap: 20px;
            }

            /* ç¡®ä¿æ‰€æœ‰éš¾åº¦åœ¨å°å±å¹•ä¸Šéƒ½é€‚é… */
            .cell {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
            }

            .info-value {
                font-size: 24px;
            }

            .face-btn {
                font-size: 40px;
            }

            /* ç¡®ä¿å®¹å™¨ä¸ä¼šæº¢å‡º */
            .game-board {
                max-width: 100vw;
                padding: 10px;
            }

            .game-board-wrapper {
                width: 100%;
                overflow: hidden;
            }
        }

        /* å¹³æ¿è®¾å¤‡ - ä¸­ç­‰å±å¹•ä¼˜åŒ– */
        @media (min-width: 601px) and (max-width: 1024px) {
            .game-board.expert .cell {
                width: 24px !important;
                height: 24px !important;
                font-size: 12px !important;
            }

            .game-board.intermediate .cell {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
            }
        }

        /* å¤§å±å¹• - ç¡®ä¿å®Œå…¨æ˜¾ç¤º */
        @media (min-width: 1025px) {
            .game-board.expert .cell {
                width: 30px !important;
                height: 30px !important;
                font-size: 16px !important;
            }

            .game-board.intermediate .cell {
                width: 32px !important;
                height: 32px !important;
                font-size: 16px !important;
            }

            .game-board.beginner .cell {
                width: 35px !important;
                height: 35px !important;
                font-size: 18px !important;
            }
        }

        .close-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ffd700;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #ffd700;
            color: #1a1a2e;
            transform: rotate(90deg);
        }

        .game-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
            color: #1a1a2e;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .leaderboard-modal {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            text-align: left;
        }

        .leaderboard-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-item:first-child {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 165, 0, 0.3) 100%);
            border: 2px solid #ffd700;
        }

        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }

        .leaderboard-player {
            flex: 1;
            padding-left: 15px;
        }

        .leaderboard-score {
            font-weight: bold;
            color: #ffd700;
        }

        .leaderboard-info {
            font-size: 12px;
            color: #aaa;
        }

        /* ç§»åŠ¨ç«¯æ§åˆ¶åŒºæ ·å¼ */
        .mobile-controls {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .control-mode-indicator {
            text-align: center;
            margin-bottom: 15px;
        }

        .mode-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .mode-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-control {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ffd700;
            background: white;
            color: #ffd700;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-control.active {
            background: #ffd700;
            color: #1e3c72;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-control:not(.active):hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .btn-control:active {
            transform: scale(0.97);
        }

        .control-hint {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #999;
        }

        /* ç§»åŠ¨ç«¯æ˜¾ç¤º */
        @media (max-width: 768px) {
            .mobile-controls {
                display: block;
            }

            .game-board {
                max-width: 100%;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="goBackHome()" title="è¿”å›ä¸»é¡µ">Ã—</button>

    <div class="game-container">
        <h1 style="text-align: center; color: #ffd700; margin-bottom: 30px;">
            âš”ï¸ æ‰«é›·æµ·æˆ˜ âš”ï¸
        </h1>

        <div class="difficulty-selector">
            <button class="diff-btn active" onclick="setDifficulty('beginner')" data-diff="beginner">
                â›µ åˆçº§ (9Ã—9, 10é›·)
            </button>
            <button class="diff-btn" onclick="setDifficulty('intermediate')" data-diff="intermediate">
                âš”ï¸ ä¸­çº§ (16Ã—16, 40é›·)
            </button>
            <button class="diff-btn" onclick="setDifficulty('expert')" data-diff="expert">
                ğŸ´â€â˜ ï¸ é«˜çº§ (30Ã—16, 99é›·)
            </button>
        </div>

        <div class="game-header">
            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">å‰©ä½™æ°´é›·</div>
                    <div class="info-value" id="mineCount">010</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ç”¨æ—¶</div>
                    <div class="info-value" id="timer">000</div>
                </div>
            </div>
            <button class="face-btn" id="faceBtn" onclick="initGame()">ğŸ˜Š</button>
        </div>

        <div class="game-board-wrapper">
            <div class="game-board" id="board"></div>
        </div>

        <div class="game-actions">
            <button class="action-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            <button class="action-btn" onclick="showLeaderboard()">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </div>

        <!-- ç§»åŠ¨ç«¯æ“ä½œæ§åˆ¶åŒº -->
        <div class="mobile-controls" id="mobileControls">
            <div class="control-mode-indicator">
                <div class="mode-label">å½“å‰æ¨¡å¼</div>
                <div class="mode-value" id="modeValue">ğŸ•µï¸ æ­å¼€æ¨¡å¼</div>
            </div>
            <div class="control-buttons">
                <button class="btn-control btn-reveal active" id="btnReveal">
                    ğŸ•µï¸ æ­å¼€
                </button>
                <button class="btn-control btn-flag" id="btnFlag">
                    ğŸš© æ ‡è®°
                </button>
            </div>
            <div class="control-hint">
                ğŸ’¡ é•¿æŒ‰æ ¼å­å¯ç›´æ¥æ ‡è®°
            </div>
        </div>

        <div class="instructions">
            <h3>ğŸ“– æ¸¸æˆè¯´æ˜</h3>
            <ul>
                <li>å·¦é”®ç‚¹å‡»ï¼šæ‰“å¼€æ ¼å­</li>
                <li>å³é”®ç‚¹å‡»ï¼šæ ‡è®°/å–æ¶ˆæ ‡è®°æ°´é›·ï¼ˆæ’æ——å¸œï¼‰</li>
                <li>æ•°å­—è¡¨ç¤ºå‘¨å›´8ä¸ªæ–¹å‘çš„æ°´é›·æ•°é‡</li>
                <li>é¦–æ¬¡ç‚¹å‡»ä¿è¯å®‰å…¨ï¼</li>
                <li>æ‰¾å‡ºæ‰€æœ‰æ°´é›·åŒºåŸŸè€Œä¸è§¦å‘åœ°é›·å³è·èƒœ</li>
                <li>ç§»åŠ¨ç«¯é•¿æŒ‰å¯æ ‡è®°æ°´é›·</li>
            </ul>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <h2 id="modalTitle">æ¸¸æˆç»“æŸ</h2>
            <p id="modalMessage"></p>
            <button class="modal-btn" onclick="closeModal()">å†æ¥ä¸€å±€</button>
            <button class="modal-btn" onclick="goBackHome()" style="background: linear-gradient(135deg, #ff6b35 0%, #e55a2b 100%); border-color: #ff6b35; color: white;">è¿”å›ä¸»é¡µ</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œå¼¹çª— -->
    <div class="modal-overlay" id="leaderboardOverlay">
        <div class="modal leaderboard-modal" id="leaderboardModal">
            <h2>ğŸ† æ‰«é›·æµ·æˆ˜æ’è¡Œæ¦œ</h2>
            <div id="leaderboardContent">
                <p>åŠ è½½ä¸­...</p>
            </div>
            <button class="modal-btn" onclick="closeLeaderboard()">å…³é—­</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const DIFFICULTIES = {
            beginner: { rows: 9, cols: 9, mines: 10 },
            intermediate: { rows: 16, cols: 16, mines: 40 },
            expert: { rows: 16, cols: 30, mines: 99 }
        };

        // æ¸¸æˆçŠ¶æ€
        let currentDifficulty = 'beginner';
        let board = [];
        let revealed = [];
        let flagged = [];
        let gameOver = false;
        let gameWon = false;
        let mineCount = 10;
        let timer = 0;
        let timerInterval = null;
        let firstClick = true;
        let rows = 9;
        let cols = 9;
        let totalMines = 10;
        // é•¿æŒ‰ç›¸å…³çŠ¶æ€
        let longPressTimer = null;
        let longPressTriggered = false;
        let touchStartX = 0;
        let touchStartY = 0;
        let currentMode = 'reveal';
        const LONG_PRESS_DURATION = 500;

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            const config = DIFFICULTIES[currentDifficulty];
            rows = config.rows;
            cols = config.cols;
            totalMines = config.mines;
            mineCount = totalMines;
            timer = 0;
            gameOver = false;
            gameWon = false;
            firstClick = true;

            // æ¸…é™¤å®šæ—¶å™¨
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // åˆå§‹åŒ–æ•°ç»„
            board = Array(rows).fill(null).map(() => Array(cols).fill(0));
            revealed = Array(rows).fill(null).map(() => Array(cols).fill(false));
            flagged = Array(rows).fill(null).map(() => Array(cols).fill(false));

            // æ›´æ–°UI
            document.getElementById('mineCount').textContent = String(mineCount).padStart(3, '0');
            document.getElementById('timer').textContent = '000';
            document.getElementById('faceBtn').textContent = 'ğŸ˜Š';

            // æ¸²æŸ“æ£‹ç›˜
            renderBoard();
        }

        // è®¾ç½®éš¾åº¦
        function setDifficulty(diff) {
            currentDifficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.diff === diff) {
                    btn.classList.add('active');
                }
            });
            initGame();
        }

        // æ”¾ç½®æ°´é›·ï¼ˆç¡®ä¿é¦–æ¬¡ç‚¹å‡»å®‰å…¨ï¼‰
        function placeMines(firstRow, firstCol) {
            let placed = 0;
            while (placed < totalMines) {
                const row = Math.floor(Math.random() * rows);
                const col = Math.floor(Math.random() * cols);

                // é¿å¼€é¦–æ¬¡ç‚¹å‡»åŠå…¶å‘¨å›´
                const isNeighbor = Math.abs(row - firstRow) <= 1 && Math.abs(col - firstCol) <= 1;
                if (board[row][col] !== -1 && !isNeighbor) {
                    board[row][col] = -1;
                    placed++;
                }
            }

            // è®¡ç®—æ•°å­—
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (board[r][c] !== -1) {
                        board[r][c] = countAdjacentMines(r, c);
                    }
                }
            }
        }

        // è®¡ç®—å‘¨å›´æ°´é›·æ•°
        function countAdjacentMines(row, col) {
            let count = 0;
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = row + dr;
                    const nc = col + dc;
                    if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc] === -1) {
                        count++;
                    }
                }
            }
            return count;
        }

        // æ¸²æŸ“æ£‹ç›˜
        function renderBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';

            // æ ¹æ®éš¾åº¦è®¾ç½®æ ¼å­å¤§å°
            let cellSize = 35;
            let gridColumns = cols;

            // ç§»é™¤æ—§çš„éš¾åº¦ç±»
            boardEl.classList.remove('beginner', 'intermediate', 'expert');

            if (currentDifficulty === 'beginner') {
                cellSize = 35;
                boardEl.classList.add('beginner');
            } else if (currentDifficulty === 'intermediate') {
                cellSize = 32;
                boardEl.classList.add('intermediate');
            } else if (currentDifficulty === 'expert') {
                cellSize = 28;
                boardEl.classList.add('expert');
            }

            boardEl.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell hidden';
                    cell.dataset.row = r;
                    cell.dataset.col = c;

                    boardEl.appendChild(cell);
                }
            }

            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼šåœ¨ boardEl ä¸Šæ·»åŠ ç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å™¨
            boardEl.addEventListener('click', handleBoardClick);
            boardEl.addEventListener('contextmenu', handleBoardContext);
            boardEl.addEventListener('touchstart', handleBoardTouchStart, { passive: true });
            boardEl.addEventListener('touchend', handleBoardTouchEnd, { passive: false });
            boardEl.addEventListener('touchmove', handleBoardTouchMove, { passive: true });
            boardEl.addEventListener('touchcancel', handleBoardTouchCancel);

            // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ§åˆ¶
            initMobileControls();
        }

        // å¤„ç†æ¿çº§ç‚¹å‡»ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        function handleBoardClick(e) {
            const cell = e.target.closest('.cell');
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            handleClick(row, col);
        }

        // å¤„ç†æ¿çº§å³é”®ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        function handleBoardContext(e) {
            const cell = e.target.closest('.cell');
            if (!cell) return;

            e.preventDefault();

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            handleRightClick(row, col);
        }

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ§åˆ¶
        function initMobileControls() {
            const btnReveal = document.getElementById('btnReveal');
            const btnFlag = document.getElementById('btnFlag');
            const modeValue = document.getElementById('modeValue');

            if (!btnReveal || !btnFlag || !modeValue) return;

            function setMode(mode) {
                currentMode = mode;
                if (mode === 'reveal') {
                    btnReveal.classList.add('active');
                    btnFlag.classList.remove('active');
                    modeValue.textContent = 'ğŸ•µï¸ æ­å¼€æ¨¡å¼';
                } else {
                    btnReveal.classList.remove('active');
                    btnFlag.classList.add('active');
                    modeValue.textContent = 'ğŸš© æ ‡è®°æ¨¡å¼';
                }

                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
            }

            btnReveal.addEventListener('click', () => setMode('reveal'));
            btnFlag.addEventListener('click', () => setMode('flag'));

            setMode('reveal');
        }

        // å¤„ç†æ¿çº§è§¦æ‘¸å¼€å§‹ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        function handleBoardTouchStart(e) {
            const cell = e.target.closest('.cell');
            if (!cell || gameOver) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            if (revealed[row][col]) return;

            // è®°å½•è§¦æ‘¸ä½ç½®
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            longPressTriggered = false;

            // å­˜å‚¨å½“å‰è§¦æ‘¸çš„ cell
            e.target.closest('.cell').classList.add('touching');

            // è®¾ç½®é•¿æŒ‰å®šæ—¶å™¨ï¼ˆ500msï¼‰
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                // æ·»åŠ è§†è§‰åé¦ˆ
                cell.classList.add('long-pressing');
                // è§¦è§‰åé¦ˆ
                navigator.vibrate?.(50);
                // æ‰§è¡Œæ ‡è®°æ“ä½œ
                handleRightClick(row, col);
                // ç§»é™¤è§†è§‰åé¦ˆ
                setTimeout(() => cell.classList.remove('long-pressing'), 150);
            }, 500);
        }

        // å¤„ç†æ¿çº§è§¦æ‘¸ç»“æŸï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        function handleBoardTouchEnd(e) {
            const cell = e.target.closest('.cell');
            if (!cell) return;

            // ç§»é™¤è§¦æ‘¸æ ‡è®°
            cell.classList.remove('touching');

            // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            // ç§»é™¤è§†è§‰åé¦ˆ
            cell.classList.remove('long-pressing');

            // å¦‚æœæ²¡æœ‰è§¦å‘é•¿æŒ‰ï¼Œåˆ™æ‰§è¡Œç‚¹å‡»
            if (!longPressTriggered) {
                const touch = e.changedTouches[0];
                const deltaX = Math.abs(touch.clientX - touchStartX);
                const deltaY = Math.abs(touch.clientY - touchStartY);

                // å¦‚æœç§»åŠ¨è·ç¦»å¾ˆå°ï¼ˆå°äº10pxï¼‰ï¼Œåˆ™è®¤ä¸ºæ˜¯ç‚¹å‡»
                if (deltaX < 10 && deltaY < 10) {
                    e.preventDefault();
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);

                    // æ ¹æ®å½“å‰æ¨¡å¼æ‰§è¡Œä¸åŒæ“ä½œ
                    if (currentMode === 'flag') {
                        handleRightClick(row, col);
                    } else {
                        handleClick(row, col);
                    }
                }
            }
        }

        // å¤„ç†æ¿çº§è§¦æ‘¸ç§»åŠ¨ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        function handleBoardTouchMove(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;

                // ç§»é™¤æ‰€æœ‰ cell çš„é•¿æŒ‰çŠ¶æ€
                const pressing = document.querySelectorAll('.long-pressing');
                pressing.forEach(el => el.classList.remove('long-pressing'));
            }
        }

        // å¤„ç†æ¿çº§è§¦æ‘¸å–æ¶ˆï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        function handleBoardTouchCancel(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;

                // ç§»é™¤æ‰€æœ‰ cell çš„è§†è§‰åé¦ˆ
                const pressing = document.querySelectorAll('.long-pressing');
                pressing.forEach(el => el.classList.remove('long-pressing'));
            }

            // ç§»é™¤è§¦æ‘¸æ ‡è®°
            const touching = document.querySelectorAll('.touching');
            touching.forEach(el => el.classList.remove('touching'));
        }

        // æ›´æ–°å•ä¸ªæ ¼å­
        function updateCell(row, col) {
            const cellIndex = row * cols + col;
            const cell = document.getElementById('board').children[cellIndex];

            if (revealed[row][col]) {
                cell.classList.remove('hidden', 'flagged');
                cell.classList.add('revealed');

                if (board[row][col] === -1) {
                    cell.classList.add('mine');
                    cell.innerHTML = 'ğŸ’£';
                } else if (board[row][col] > 0) {
                    cell.innerHTML = board[row][col];
                    cell.classList.add(`number-${board[row][col]}`);
                }
            } else if (flagged[row][col]) {
                cell.classList.add('flagged');
                cell.innerHTML = 'ğŸš©';
            } else {
                cell.classList.remove('revealed', 'flagged', 'mine');
                cell.classList.add('hidden');
                cell.innerHTML = '';
            }
        }

        // å¤„ç†å·¦é”®ç‚¹å‡»
        function handleClick(row, col) {
            if (gameOver || revealed[row][col] || flagged[row][col]) return;

            // é¦–æ¬¡ç‚¹å‡»
            if (firstClick) {
                firstClick = false;
                placeMines(row, col);
                startTimer();
            }

            // è¸©åˆ°æ°´é›·
            if (board[row][col] === -1) {
                gameOver = true;
                revealAllMines(row, col);
                updateCell(row, col);
                document.querySelector(`[data-row="${row}"][data-col="${col}"]`).classList.add('exploded');
                endGame(false);
                return;
            }

            // é€’å½’æ‰“å¼€
            revealCell(row, col);

            // æ£€æŸ¥èƒœåˆ©
            if (checkWin()) {
                endGame(true);
            }
        }

        // å¤„ç†å³é”®ç‚¹å‡»
        function handleRightClick(row, col) {
            if (gameOver || revealed[row][col]) return;

            flagged[row][col] = !flagged[row][col];
            mineCount += flagged[row][col] ? -1 : 1;
            document.getElementById('mineCount').textContent = String(mineCount).padStart(3, '0');
            updateCell(row, col);
        }

        // é€’å½’æ‰“å¼€æ ¼å­
        function revealCell(row, col) {
            if (row < 0 || row >= rows || col < 0 || col >= cols) return;
            if (revealed[row][col] || flagged[row][col]) return;

            revealed[row][col] = true;
            updateCell(row, col);

            // å¦‚æœæ˜¯0ï¼Œé€’å½’æ‰“å¼€å‘¨å›´
            if (board[row][col] === 0) {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        revealCell(row + dr, col + dc);
                    }
                }
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ°´é›·
        function revealAllMines(explodedRow, explodedCol) {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (board[r][c] === -1 && !(r === explodedRow && c === explodedCol)) {
                        revealed[r][c] = true;
                        updateCell(r, c);
                    }
                }
            }
        }

        // æ£€æŸ¥èƒœåˆ©
        function checkWin() {
            let unrevealedSafe = 0;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (!revealed[r][c] && board[r][c] !== -1) {
                        unrevealedSafe++;
                    }
                }
            }
            return unrevealedSafe === 0;
        }

        // å¼€å§‹è®¡æ—¶
        function startTimer() {
            timerInterval = setInterval(() => {
                timer++;
                if (timer > 999) timer = 999;
                document.getElementById('timer').textContent = String(timer).padStart(3, '0');
            }, 1000);
        }

        // æ¸¸æˆç»“æŸ
        function endGame(won) {
            gameOver = true;
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            const faceBtn = document.getElementById('faceBtn');
            faceBtn.textContent = won ? 'ğŸ˜' : 'ğŸ˜';

            if (won) {
                gameWon = true;
                // æ ‡è®°æ‰€æœ‰æ°´é›·
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        if (board[r][c] === -1 && !flagged[r][c]) {
                            flagged[r][c] = true;
                            updateCell(r, c);
                        }
                    }
                }
                document.getElementById('mineCount').textContent = '000';

                // æ˜¾ç¤ºèƒœåˆ©å¼¹çª—
                setTimeout(() => {
                    showModal('ğŸ‰ æ­å–œèƒœåˆ©ï¼', `ä½ æˆåŠŸæ’é™¤äº†æ‰€æœ‰æ°´é›·ï¼\n\néš¾åº¦ï¼š${getDifficultyName()}\nç”¨æ—¶ï¼š${timer}ç§’`);
                    uploadScore();
                }, 500);
            } else {
                setTimeout(() => {
                    showModal('ğŸ’¥ æ¸¸æˆå¤±è´¥', `ä½ è¸©åˆ°äº†æ°´é›·ï¼\n\néš¾åº¦ï¼š${getDifficultyName()}\nç”¨æ—¶ï¼š${timer}ç§’`);
                }, 500);
            }
        }

        // è·å–éš¾åº¦åç§°
        function getDifficultyName() {
            const names = {
                beginner: 'åˆçº§',
                intermediate: 'ä¸­çº§',
                expert: 'é«˜çº§'
            };
            return names[currentDifficulty];
        }

        // ä¸Šä¼ åˆ†æ•°
        async function uploadScore() {
            try {
                let playerName = prompt('è¯·è¾“å…¥ä½ çš„åå­—ç”¨äºæ’è¡Œæ¦œï¼š', 'æµ·è´¼çŒäºº');

                // ç©ºå€¼éªŒè¯
                if (!playerName || playerName.trim() === '') {
                    alert('åå­—ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥æœ‰æ•ˆåå­—');
                    return;
                }

                // è¿›ä¸€æ­¥éªŒè¯ï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸­æ–‡ï¼‰
                const trimmedName = playerName.trim();
                if (trimmedName.length < 1 || trimmedName.length > 20) {
                    alert('åå­—é•¿åº¦å¿…é¡»åœ¨1-20ä¸ªå­—ç¬¦ä¹‹é—´');
                    return;
                }

                const response = await fetch('/api/leaderboard/minesweeper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerName: trimmedName,
                        score: timer,
                        metadata: {
                            difficulty: currentDifficulty,
                            rows: rows,
                            cols: cols,
                            mines: totalMines
                        }
                    })
                });

                if (response.ok) {
                    alert('åˆ†æ•°å·²ä¸Šä¼ åˆ°æ’è¡Œæ¦œï¼');
                } else {
                    console.error('ä¸Šä¼ åˆ†æ•°å¤±è´¥:', response.status);
                    alert('ä¸Šä¼ åˆ†æ•°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('ä¸Šä¼ åˆ†æ•°å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ åˆ†æ•°å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºå¼¹çª—
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            initGame();
        }

        // åˆå§‹åŒ–
        initGame();

        // è¿”å›ä¸»é¡µ
        function goBackHome() {
            window.location.href = '../index.html';
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            initGame();
        }

        // æ˜¾ç¤ºæ’è¡Œæ¦œ
        async function showLeaderboard() {
            const overlay = document.getElementById('leaderboardOverlay');
            const content = document.getElementById('leaderboardContent');

            overlay.style.display = 'flex';
            content.innerHTML = '<p>åŠ è½½ä¸­...</p>';

            try {
                // æ·»åŠ æ—¶é—´æˆ³é¿å…æµè§ˆå™¨ç¼“å­˜
                const response = await fetch('/api/leaderboard/minesweeper?t=' + Date.now());
                if (response.ok) {
                    const result = await response.json();
                    const data = result.success ? result.leaderboard : result;
                    displayLeaderboard(data);
                } else {
                    content.innerHTML = '<p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
                }
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
                content.innerHTML = '<p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            }
        }

        // æ˜¾ç¤ºæ’è¡Œæ¦œæ•°æ®
        function displayLeaderboard(data) {
            const content = document.getElementById('leaderboardContent');

            if (!data || data.length === 0) {
                content.innerHTML = '<p>æš‚æ— æ’è¡Œæ¦œæ•°æ®</p>';
                return;
            }

            const difficultyNames = {
                beginner: 'åˆçº§',
                intermediate: 'ä¸­çº§',
                expert: 'é«˜çº§'
            };

            let html = '<ul class="leaderboard-list">';
            data.slice(0, 20).forEach((entry, index) => {
                const rank = index + 1;
                const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
                const playerName = entry.playerName || entry.name || 'åŒ¿åç©å®¶';
                const difficulty = entry.metadata && entry.metadata.difficulty ? difficultyNames[entry.metadata.difficulty] : 'æœªçŸ¥';
                const date = new Date(entry.timestamp).toLocaleDateString('zh-CN');

                html += `
                    <li class="leaderboard-item">
                        <div class="leaderboard-rank">${rankEmoji}</div>
                        <div class="leaderboard-player">
                            <div>${playerName}</div>
                            <div class="leaderboard-info">${difficulty} | ${entry.metadata && entry.metadata.mines + 'é›·' || ''} | ${date}</div>
                        </div>
                        <div class="leaderboard-score">${entry.score}ç§’</div>
                    </li>
                `;
            });
            html += '</ul>';

            content.innerHTML = html;
        }

        // å…³é—­æ’è¡Œæ¦œ
        function closeLeaderboard() {
            document.getElementById('leaderboardOverlay').style.display = 'none';
        }
    </script>
</body>
</html>